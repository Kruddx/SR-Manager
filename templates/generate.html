{% extends "base.html" %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON - SR-Manager{% endblock %}

{% block content %}
<div class="grid grid-2">
    <div class="card">
        <h1>üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON –¥–∞–Ω–Ω—ã—Ö</h1>
        
        <div class="form-group">
            <label for="instances">–í—ã–±–µ—Ä–∏—Ç–µ instances:</label>
            <select id="instances" class="form-control">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ instances --</option>
            </select>
        </div>
        
        <button class="btn btn-success" onclick="generateJson()" style="width: 100%;">
            üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON
        </button>

        <div id="stats" class="card" style="display: none; margin-top: 20px;">
            <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
            <p>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏–≥—Ä–æ–∫–æ–≤: <strong><span id="playerCount">0</span></strong></p>
            <p>Instances: <strong><span id="instancesName">-</span></strong></p>
        </div>
    </div>

    <div class="card">
        <div id="result" style="display: none;">
            <h3>üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç (base64):</h3>
            <textarea id="outputData" class="form-control" readonly></textarea>
            <button class="btn btn-secondary copy-btn" onclick="copyToClipboard()" style="width: 100%; margin-top: 10px;">
                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä
            </button>
        </div>

        <div id="error" style="display: none;" class="alert alert-error"></div>

        <div style="margin-top: 20px;">
            <h4>üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h4>
            <ol style="line-height: 1.6;">
                <li>–í—ã–±–µ—Ä–∏—Ç–µ instances –∏–∑ —Å–ø–∏—Å–∫–∞</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON"</li>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –Ω—É–∂–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ</li>
            </ol>
        </div>
    </div>
</div>

<script>
// JavaScript –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    loadInstances();
});

function loadInstances() {
    fetch('/api/instances')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('instances');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ instances --</option>';
            
            data.instances.forEach(instance => {
                const option = document.createElement('option');
                option.value = instance;
                option.textContent = instance;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ instances:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ instances: ' + error);
        });
}

function generateJson() {
    const instances = document.getElementById('instances').value;
    if (!instances) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ instances');
        return;
    }

    document.getElementById('result').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('stats').style.display = 'block';
    document.getElementById('playerCount').textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    document.getElementById('instancesName').textContent = instances;

    fetch(`/generate/${encodeURIComponent(instances)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('outputData').value = data.encoded_data;
                document.getElementById('result').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('playerCount').textContent = data.total_players;
                document.getElementById('instancesName').textContent = data.instances;
            } else {
                showError(data.error);
                document.getElementById('stats').style.display = 'none';
            }
        })
        .catch(error => {
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ JSON: ' + error);
            document.getElementById('stats').style.display = 'none';
        });
}

function copyToClipboard() {
    const textarea = document.getElementById('outputData');
    textarea.select();
    document.execCommand('copy');
    alert('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
}

function showError(message) {
    document.getElementById('error').textContent = message;
    document.getElementById('error').style.display = 'block';
    document.getElementById('result').style.display = 'none';
    document.getElementById('stats').style.display = 'none';
}
</script>
{% endblock %}